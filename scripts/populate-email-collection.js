var fs = require('fs');
var nodemailer = require('nodemailer');
var Server = require("mongo-sync").Server;
var server = new Server("localhost");
var db = server.db("exciting");
var sleep = require("sleep");

var transporter = nodemailer.createTransport({
  service: 'Hotmail',
  auth: {
    user: 'jesse.warren@live.com',
    pass: 'captaincrunch28!'
  }
});

function constructMessage(name, links) {
  var text = name + ",\n\nAs part of a capstone course, we have built a pipeline for generating short summaries of academic papers from their in-text citations in other works. We want to evaluate the correctness and usefulness of the summaries generated by this pipeline.\n\nThe following links will take you to a web form where you can evaluate the summaries generated by our pipeline for your most influential papers. We would greatly appreciate a few minutes of your time to fill out if you have any other feedback, questions or concerns, don't hesitate to contact us directly.Thanks again for your time!\n\n";

  links.forEach(function(link) {
    text += link + "\n"
  });

  text +=  "\nTrevor Killeen\nGraeme Britz\nJesse Warren\nUniversity of Washington Department of Computer Science";
  return text;
}

var seen = [];
var email_chunks = db.getCollection("emails_test").find().toArray();
email_chunks.forEach(function(email_chunk) {
  var mailOptions = {
    from: 'Jesse Warren <jesse.warre@gmail.com>', // sender address
    to: email_chunk.email, // list of receivers
    subject: 'Feedback requested for Information Extraction project at the University of Washington', // Subject line
    text: constructMessage(email_chunk.name, email_chunk.papers)
  };

  transporter.sendMail(mailOptions, function(error, info){
    if (error) {
      console.log(error);
    } else {
      console.log('Message sent: ' + info.response);
    }
    sleep.sleep(1);
  });
});

server.close();
